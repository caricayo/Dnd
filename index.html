<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>D&D DM ‚Äî Voice + Art</title>
<style>
  :root{--bg:#0b0c10;--panel:#111318;--ink:#e6e8ef;--muted:#a3a7b7;--accent:#6ee7b7;--brand:#6366f1;--chip:#1b1e27;--border:#212432}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,SF Pro Text,Helvetica,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--ink);border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .log{height:52vh;overflow:auto;padding:12px}
  .msg{margin:10px 0;display:flex;gap:10px}
  .msg.user{justify-content:flex-end}
  .bubble{padding:10px 12px;border-radius:14px;background:var(--chip);max-width:75%}
  .msg.user .bubble{background:#1f2433}
  .role{font-size:12px;color:var(--muted);margin-bottom:4px}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
  .composer input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0e111a;color:var(--ink)}
  details{margin-top:12px} summary{cursor:pointer;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field input,.field select{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e111a;color:var(--ink)}
  .note{color:var(--muted);font-size:13px}
  /* Art panel */
  .art-panel{position:sticky;bottom:0;margin-top:12px;padding:10px;background:rgba(17,19,24,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:16px;display:grid;grid-template-columns:90px 1fr auto;gap:10px;align-items:center}
  .art-thumb{width:90px;height:90px;object-fit:cover;border-radius:12px;border:1px solid var(--border);background:#0e111a}
  .art-actions{display:flex;gap:8px}
  .hidden{display:none}
  /* Fullscreen modal */
  .fs-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .fs-img{max-width:96vw;max-height:92vh;border-radius:16px;border:1px solid var(--border)}
  @media (max-width:700px){
    .log{height:50vh}
    .art-panel{grid-template-columns:70px 1fr;gap:8px}
    .art-actions{grid-column:1 / -1}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üßô‚Äç‚ôÇÔ∏è D&D DM ‚Äî Voice + Art</h1>
    <div class="toolbar">
      <button id="holdToTalk" class="btn-ghost">üéôÔ∏è Hold to talk</button>
      <label class="btn-ghost" style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="ttsToggle"> Narrator TTS
      </label>
      <button id="resetBtn" class="btn-ghost">Reset</button>
      <button id="settingsBtn" class="btn">Settings</button>
    </div>
  </header>

  <div class="card">
    <div id="log" class="log"></div>
    <div class="composer">
      <input id="input" placeholder="Say something to the DM‚Ä¶ (e.g., We enter the ruined city)"/>
      <button id="send" class="btn">Send</button>
    </div>
  </div>

  <details class="card" id="settingsPanel">
    <summary>‚öôÔ∏è Settings</summary>
    <div style="padding:14px" class="grid">
      <div class="field">
        <label>API Proxy URL (Cloudflare Worker)</label>
        <input id="apiUrl" placeholder="https://dnd-openai-proxy.<subdomain>.workers.dev"/>
        <div class="note">Your Worker‚Äôs <code>/chat</code> endpoint.</div>
      </div>
      <div class="field">
        <label>Generate images</label>
        <select id="imagesMode">
          <option value="auto">Auto (scene ‚â† none)</option>
          <option value="manual">Manual (only when pressed)</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div class="field">
        <label>Image size (cost control)</label>
        <select id="imgSize">
          <option value="1024">1024√ó1024</option>
          <option value="512">512√ó512</option>
          <option value="256">256√ó256</option>
        </select>
      </div>
      <div class="field">
        <label>Narrator voice</label>
        <select id="voiceSelect"></select>
        <div class="note">Uses your browser‚Äôs voices.</div>
      </div>
    </div>
    <div style="padding:0 14px 14px 14px;display:flex;gap:10px">
      <button id="saveSettings" class="btn">Save</button>
      <button id="clearSettings" class="btn-ghost">Clear</button>
      <button id="exportBtn" class="btn-ghost">Export Session</button>
    </div>
  </details>

  <!-- Art panel (sticky) -->
  <div class="art-panel">
    <img id="artThumb" class="art-thumb" alt="No art"/>
    <div>
      <div style="font-weight:700">Scene Art</div>
      <div id="artNote" class="note">No image yet.</div>
    </div>
    <div class="art-actions">
      <button id="viewFull" class="btn-ghost hidden">View</button>
      <button id="genArt" class="btn-ghost">Generate Art</button>
    </div>
  </div>
</div>

<!-- Fullscreen viewer -->
<div id="fs" class="fs-backdrop"><img id="fsImg" class="fs-img" alt="Art"/></div>

<script>
  // ---------- CONFIG ----------
  const API_BASE_DEFAULT = "https://dnd-openai-proxy.christestdnd.workers.dev"; // change if needed

  // ---------- STATE ----------
  const state = {
    apiBase: localStorage.getItem("apiBase") || API_BASE_DEFAULT,
    imagesMode: localStorage.getItem("imagesMode") || "auto",
    imgSize: localStorage.getItem("imgSize") || "1024",
    tts: JSON.parse(localStorage.getItem("tts") || "false"),
    voiceName: localStorage.getItem("voiceName") || "",
    history: [],          // { role, text, scene?, imageUrl? }
    lastSceneIndex: null, // index of last assistant msg with scene!=none
    latestImageUrl: null
  };

  // ---------- ELEMENTS ----------
  const el = id => document.getElementById(id);
  const logEl = el("log");
  const speakBtn = el("holdToTalk");
  el("apiUrl").value = state.apiBase;
  el("imagesMode").value = state.imagesMode;
  el("imgSize").value = state.imgSize;
  el("ttsToggle").checked = state.tts;

  // ---------- RENDER ----------
  function render() {
    logEl.innerHTML = "";
    state.history.forEach((m,i)=>{
      const row = document.createElement("div");
      row.className = "msg " + (m.role==="user"?"user":"assistant");
      const b = document.createElement("div");
      b.className = "bubble";
      const r = document.createElement("div"); r.className = "role"; r.textContent = m.role.toUpperCase();
      const t = document.createElement("div"); t.textContent = m.text;
      b.appendChild(r); b.appendChild(t); row.appendChild(b);

      if (m.imageUrl){
        const img = document.createElement("img");
        img.src = m.imageUrl; img.className="img"; img.alt = m.scene||"scene";
        row.appendChild(img);
      }

      if (m.role==="assistant" && m.scene && m.scene!=="none" && !m.imageUrl && state.imagesMode==="manual") {
        const btn = document.createElement("button");
        btn.textContent = "Generate Art for this scene";
        btn.className = "btn-ghost";
        btn.onclick = ()=> generateArt(i);
        row.appendChild(btn);
      }

      logEl.appendChild(row);
    });
    logEl.scrollTop = logEl.scrollHeight;

    // update art panel
    const artThumb = el("artThumb");
    const artNote  = el("artNote");
    const viewBtn  = el("viewFull");
    if (state.latestImageUrl){
      artThumb.src = state.latestImageUrl;
      artNote.textContent = "Latest generated scene";
      viewBtn.classList.remove("hidden");
    } else {
      artThumb.src = "";
      artThumb.alt = "No art";
      artNote.textContent = "No image yet.";
      viewBtn.classList.add("hidden");
    }
  }

  // ---------- CHAT ----------
  async function send() {
    const text = el("input").value.trim();
    if (!text) return;
    el("input").value = "";
    state.history.push({ role:"user", text });
    render();

    let data;
    try{
      const res = await fetch(state.apiBase.replace(/\/$/,"") + "/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          messages: state.history.map(m=>({ role:m.role, content:m.text })),
          imgSize: state.imgSize // reserved; Worker can use later
        })
      });
      data = await res.json();
    }catch(e){
      data = { reply:"(Network error. Check API URL in Settings.)", scene:"none" };
    }

    let sceneIndex = null;
    if (data.scene && data.scene !== "none") sceneIndex = state.history.length;

    let imageUrl = null;
    if (state.imagesMode==="auto" && data.scene && data.scene!=="none") {
      imageUrl = data.imageUrl || null;
      if (imageUrl) state.latestImageUrl = imageUrl;
    }

    state.history.push({ role:"assistant", text: data.reply || "(No reply)", scene: data.scene||"none", imageUrl });
    if (sceneIndex !== null) state.lastSceneIndex = sceneIndex;

    render();
    speak(data.reply);
  }

  // ---------- MANUAL ART ----------
  async function generateArt(indexOverride) {
    const idx = (typeof indexOverride === "number") ? indexOverride : state.lastSceneIndex;
    if (idx == null) { alert("No recent scene to illustrate yet."); return; }
    const m = state.history[idx];
    if (!m || m.role!=="assistant" || !m.scene || m.scene==="none") { alert("That turn doesn't need art."); return; }

    try{
      const res = await fetch(state.apiBase.replace(/\/$/,"") + "/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          messages: [
            ...state.history.map(x=>({ role:x.role, content:x.text })),
            { role:"user", content:"Generate an illustration for the last scene only." }
          ]
        })
      });
      const data = await res.json();
      if (data.imageUrl){
        m.imageUrl = data.imageUrl;
        state.latestImageUrl = data.imageUrl;
        render();
      } else {
        alert("No image returned. If your org just got verified, give it a few minutes and try again.");
      }
    }catch(e){
      alert("Network error generating art.");
    }
  }

  // ---------- TTS (Narrator) ----------
  const synth = window.speechSynthesis;
  let voices = [];
  function loadVoices(){
    voices = synth.getVoices();
    const sel = el("voiceSelect");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "System Default";
    sel.appendChild(opt0);
    voices.forEach(v=>{
      const o = document.createElement("option");
      o.value = v.name; o.textContent = `${v.name} ${v.lang ? "(" + v.lang + ")" : ""}`;
      sel.appendChild(o);
    });
    sel.value = state.voiceName;
  }
  loadVoices();
  if (synth) synth.onvoiceschanged = loadVoices;

  function speak(text){
    if (!state.tts || !text) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      if (state.voiceName){
        const v = voices.find(v=>v.name===state.voiceName);
        if (v) u.voice = v;
      }
      u.rate = 1.02; u.pitch = 1.0;
      synth.cancel(); synth.speak(u);
    }catch(e){}
  }

  // ---------- STT (Player mic) ----------
  const hasSTT = ('webkitSpeechRecognition' in window) && (window.isSecureContext || location.hostname==='localhost');
  const rec = hasSTT ? new webkitSpeechRecognition() : null;
  if (rec){
    rec.lang = 'en-US'; rec.continuous = false; rec.interimResults = false;
    let holding = false;
    speakBtn.onmousedown = ()=>{ holding=true; rec.start(); speakBtn.textContent="üéôÔ∏è Listening‚Ä¶ release to send"; };
    speakBtn.onmouseup   = ()=>{ if(holding){ holding=false; rec.stop(); speakBtn.textContent="üéôÔ∏è Hold to talk"; } };
    rec.onresult = (e)=>{ const t = Array.from(e.results).map(r=>r[0].transcript).join(' '); el("input").value = t; send(); };
  } else {
    speakBtn.textContent = "üéôÔ∏è Mic requires HTTPS";
    speakBtn.disabled = true;
  }

  // ---------- UI WIRING ----------
  el("send").onclick = send;
  el("input").addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });
  el("settingsBtn").onclick = ()=> el("settingsPanel").open = !el("settingsPanel").open;
  el("saveSettings").onclick = ()=>{
    state.apiBase   = el("apiUrl").value.trim() || state.apiBase;
    state.imagesMode= el("imagesMode").value;
    state.imgSize   = el("imgSize").value;
    state.tts       = el("ttsToggle").checked;
    state.voiceName = el("voiceSelect").value;
    localStorage.setItem("apiBase", state.apiBase);
    localStorage.setItem("imagesMode", state.imagesMode);
    localStorage.setItem("imgSize", state.imgSize);
    localStorage.setItem("tts", JSON.stringify(state.tts));
    localStorage.setItem("voiceName", state.voiceName);
    alert("Saved.");
  };
  el("clearSettings").onclick = ()=>{
    localStorage.removeItem("apiBase");
    localStorage.removeItem("imagesMode");
    localStorage.removeItem("imgSize");
    localStorage.removeItem("tts");
    localStorage.removeItem("voiceName");
    el("apiUrl").value = API_BASE_DEFAULT;
    el("imagesMode").value = "auto";
    el("imgSize").value = "1024";
    el("ttsToggle").checked = false;
    alert("Settings cleared.");
  };
  el("resetBtn").onclick = ()=>{ state.history=[]; state.latestImageUrl=null; state.lastSceneIndex=null; render(); };
  el("exportBtn").onclick = ()=>{
    const blob = new Blob([JSON.stringify(state.history,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="session.json"; a.click();
    URL.revokeObjectURL(url);
  };
  el("genArt").onclick = ()=> generateArt();
  el("viewFull").onclick = ()=>{
    if(!state.latestImageUrl) return;
    el("fsImg").src = state.latestImageUrl;
    el("fs").style.display = "flex";
  };
  el("fs").onclick = ()=>{ el("fs").style.display = "none"; };

  // Boot
  render();
</script>
</body>
</html>
