<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>D&D DM ‚Äî Chat + Optional Art</title>
<style>
  :root{--bg:#0b0c10;--panel:#111318;--ink:#e6e8ef;--muted:#a3a7b7;--accent:#6ee7b7;--brand:#6366f1;--chip:#1b1e27;--border:#212432}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,SF Pro Text,Helvetica,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--ink);border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .log{height:60vh;overflow:auto;padding:16px}
  .msg{margin:12px 0;display:flex;gap:12px}
  .msg.user{justify-content:flex-end}
  .bubble{padding:12px 14px;border-radius:14px;background:var(--chip);max-width:72%}
  .msg.user .bubble{background:#1f2433}
  .role{font-size:12px;color:var(--muted);margin-bottom:4px}
  .img{margin-top:8px;border-radius:14px;border:1px solid var(--border);max-width:520px}
  .composer{display:flex;gap:10px;padding:10px;border-top:1px solid var(--border)}
  .composer input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0e111a;color:var(--ink)}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  details{margin-top:12px}
  summary{cursor:pointer;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field input,.field select{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e111a;color:var(--ink)}
  .note{color:var(--muted);font-size:13px}
  footer{margin-top:12px;color:var(--muted);font-size:12px}
  @media (max-width:800px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üßô‚Äç‚ôÇÔ∏è D&D DM ‚Äî Chat + Optional Art</h1>
    <div class="toolbar">
      <button id="clearBtn" class="btn-ghost">Reset Session</button>
      <button id="exportBtn" class="btn-ghost">Export</button>
      <button id="settingsBtn" class="btn">Settings</button>
    </div>
  </header>

  <div class="card">
    <div id="log" class="log"></div>
    <div class="composer">
      <input id="input" placeholder="Say something to the DM‚Ä¶ (e.g., We enter the ruined city)"/>
      <button id="send" class="btn">Send</button>
    </div>
  </div>

  <details class="card" id="settingsPanel">
    <summary>‚öôÔ∏è Settings</summary>
    <div style="padding:14px" class="grid">
      <div class="field">
        <label>API Proxy URL (your Cloudflare Worker)</label>
        <input id="apiUrl" placeholder="https://dnd-openai-proxy.<subdomain>.workers.dev"/>
        <div class="note">This calls your Worker‚Äôs <code>/chat</code> endpoint.</div>
      </div>
      <div class="field">
        <label>Generate images</label>
        <select id="imagesMode">
          <option value="auto">Auto (when scene != none)</option>
          <option value="manual">Manual (only on button)</option>
          <option value="off">Off (never)</option>
        </select>
        <div class="note">Use Manual/Off to control cost.</div>
      </div>
      <div class="field">
        <label>Image size</label>
        <select id="imgSize">
          <option value="1024">1024 √ó 1024 (higher cost)</option>
          <option value="512">512 √ó 512 (cheaper)</option>
          <option value="256">256 √ó 256 (cheapest)</option>
        </select>
      </div>
    </div>
    <div style="padding:0 14px 14px 14px;display:flex;gap:10px">
      <button id="saveSettings" class="btn">Save</button>
      <button id="clearSettings" class="btn-ghost">Clear</button>
    </div>
  </details>

  <footer>Tip: set Images to <b>Manual</b> to avoid surprise charges; click the ‚ÄúGenerate Art‚Äù button that appears on relevant turns.</footer>
</div>

<script>
  // ---- USER CONFIG ----
  const API_BASE_DEFAULT = "https://dnd-openai-proxy.christestdnd.workers.dev"; // change if needed

  // ---- STATE ----
  const state = {
    apiBase: localStorage.getItem("apiBase") || API_BASE_DEFAULT,
    imagesMode: localStorage.getItem("imagesMode") || "auto",
    imgSize: localStorage.getItem("imgSize") || "1024",
    history: [] // { role, text, scene?, imageUrl? }
  };

  // ---- ELEMENTS ----
  const el = id => document.getElementById(id);
  const logEl = el("log");
  el("apiUrl").value = state.apiBase;
  el("imagesMode").value = state.imagesMode;
  el("imgSize").value = state.imgSize;

  // ---- RENDER ----
  function render() {
    logEl.innerHTML = "";
    state.history.forEach((m, i) => {
      const row = document.createElement("div");
      row.className = "msg " + (m.role === "user" ? "user" : "assistant");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      const r = document.createElement("div");
      r.className = "role";
      r.textContent = m.role.toUpperCase();
      const t = document.createElement("div");
      t.textContent = m.text;
      bubble.appendChild(r); bubble.appendChild(t);
      row.appendChild(bubble);

      // Show image if present
      if (m.imageUrl) {
        const img = document.createElement("img");
        img.src = m.imageUrl;
        img.className = "img";
        img.alt = m.scene || "scene";
        row.appendChild(img);
      }

      // Manual art button for assistant messages that have a scene but no image yet
      if (m.role === "assistant" && m.scene && m.scene !== "none" && !m.imageUrl && state.imagesMode === "manual") {
        const btn = document.createElement("button");
        btn.textContent = "Generate Art";
        btn.className = "btn-ghost";
        btn.onclick = () => generateArt(i);
        row.appendChild(btn);
      }

      logEl.appendChild(row);
    });
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ---- CHAT ----
  async function send() {
    const text = el("input").value.trim();
    if (!text) return;
    state.history.push({ role: "user", text });
    render();
    el("input").value = "";

    // Call your Worker
    let data;
    try {
      const res = await fetch(state.apiBase.replace(/\/$/, "") + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: state.history.map(m => ({ role: m.role, content: m.text })),
          // The Worker ignores img size right now, but we keep it for future.
          imgSize: state.imgSize
        })
      });
      data = await res.json();
    } catch (e) {
      data = { reply: "(Network error. Check API URL in Settings.)", scene: "none" };
    }

    // Optional cost control: only attach imageUrl if mode permits
    let imageUrl = null;
    if (state.imagesMode === "auto" && data.scene && data.scene !== "none") {
      // If Worker returned an image, use it; else leave null (you can later click Generate Art)
      imageUrl = data.imageUrl || null;
    }

    state.history.push({
      role: "assistant",
      text: data.reply || "(No reply)",
      scene: data.scene || "none",
      imageUrl
    });
    render();
  }

  // Manual art generation (calls the Worker again but just for image)
  async function generateArt(idx) {
    const m = state.history[idx];
    if (!m || m.role !== "assistant" || !m.scene || m.scene === "none") return;

    // Simple re-ask technique: send the last assistant text as the context asking for image_prompt
    // Your Worker already generates image when scene!=none; this call just re-triggers it.
    try {
      const res = await fetch(state.apiBase.replace(/\/$/, "") + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [
            ...state.history.map(x => ({ role: x.role, content: x.text })),
            { role: "user", content: "Generate an illustration for the last scene only." }
          ]
        })
      });
      const data = await res.json();
      // If imageUrl came back, attach it; otherwise fallback placeholder
      m.imageUrl = data.imageUrl || `https://placehold.co/1024x1024/png?text=${encodeURIComponent((m.scene||"scene").toUpperCase())}`;
      render();
    } catch (e) {
      m.imageUrl = `https://placehold.co/1024x1024/png?text=${encodeURIComponent((m.scene||"scene").toUpperCase())}`;
      render();
    }
  }

  // ---- UI WIRING ----
  el("send").onclick = send;
  el("input").addEventListener("keydown", e => { if (e.key === "Enter") send(); });
  el("settingsBtn").onclick = () => el("settingsPanel").open = !el("settingsPanel").open;

  el("saveSettings").onclick = () => {
    state.apiBase = el("apiUrl").value.trim() || state.apiBase;
    state.imagesMode = el("imagesMode").value;
    state.imgSize = el("imgSize").value;
    localStorage.setItem("apiBase", state.apiBase);
    localStorage.setItem("imagesMode", state.imagesMode);
    localStorage.setItem("imgSize", state.imgSize);
    alert("Saved.");
  };

  el("clearSettings").onclick = () => {
    localStorage.removeItem("apiBase");
    localStorage.removeItem("imagesMode");
    localStorage.removeItem("imgSize");
    el("apiUrl").value = API_BASE_DEFAULT;
    el("imagesMode").value = "auto";
    el("imgSize").value = "1024";
    alert("Settings cleared.");
  };

  el("clearBtn").onclick = () => { state.history = []; render(); };
  el("exportBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(state.history, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "session.json"; a.click();
    URL.revokeObjectURL(url);
  };

  // Boot
  render();
</script>
</body>
</html>
