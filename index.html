<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>D&D DM ‚Äî Voice + Art</title>
<style>
  :root{--bg:#0b0c10;--panel:#111318;--ink:#e6e8ef;--muted:#a3a7b7;--brand:#6366f1;--chip:#1b1e27;--border:#212432;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,SF Pro Text,Helvetica,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--ink);border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .log{height:52vh;overflow:auto;padding:12px}
  .msg{margin:10px 0;display:flex;gap:10px}
  .msg.user{justify-content:flex-end}
  .bubble{padding:10px 12px;border-radius:14px;background:var(--chip);max-width:75%}
  .msg.user .bubble{background:#1f2433}
  .role{font-size:12px;color:var(--muted);margin-bottom:4px}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
  .composer input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0e111a;color:var(--ink)}
  details{margin-top:12px} summary{cursor:pointer;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field input,.field select{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e111a;color:var(--ink)}
  .note{color:var(--muted);font-size:13px}
  /* Status + errors */
  .status{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .badge{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .ok{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35)}
  .warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.35)}
  .err{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}
  .errbox{margin-top:10px;padding:10px;border:1px solid rgba(239,68,68,.45);border-radius:12px;background:rgba(239,68,68,.08);white-space:pre-wrap;font-size:13px}
  /* Art panel */
  .art-panel{position:sticky;bottom:0;margin-top:12px;padding:10px;background:rgba(17,19,24,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:16px;display:grid;grid-template-columns:90px 1fr auto;gap:10px;align-items:center}
  .art-thumb{width:90px;height:90px;object-fit:cover;border-radius:12px;border:1px solid var(--border);background:#0e111a}
  .art-actions{display:flex;gap:8px}
  .hidden{display:none}
  /* Fullscreen modal */
  .fs-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .fs-img{max-width:96vw;max-height:92vh;border-radius:16px;border:1px solid var(--border)}
  @media (max-width:700px){
    .log{height:50vh}
    .art-panel{grid-template-columns:70px 1fr;gap:8px}
    .art-actions{grid-column:1 / -1}
  }
  /* Revision tag */
  #revisionTag {
    position: fixed;
    bottom: 8px;
    right: 12px;
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    background: rgba(0,0,0,0.35);
    padding: 4px 8px;
    border-radius: 6px;
    pointer-events: none;
    z-index: 9999;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üßô‚Äç‚ôÇÔ∏è D&D DM ‚Äî Voice + Art</h1>
    <div class="toolbar">
      <button id="holdToTalk" class="btn-ghost">üéôÔ∏è Hold to talk</button>
      <label class="btn-ghost" style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="ttsToggle"> Narrator TTS
      </label>
      <button id="resetBtn" class="btn-ghost">Reset</button>
      <button id="settingsBtn" class="btn">Settings</button>
    </div>
  </header>

  <div class="status">
    <span id="apiBadge" class="badge warn">API: unknown</span>
    <span id="secureBadge" class="badge warn">Secure: checking‚Ä¶</span>
  </div>
  <div id="errbox" class="errbox hidden"></div>

  <div class="card">
    <div id="log" class="log"></div>
    <div class="composer">
      <input id="input" placeholder="Say something to the DM‚Ä¶ (e.g., We enter the ruined city)"/>
      <button id="send" class="btn">Send</button>
    </div>
  </div>

  <details class="card" id="settingsPanel">
    <summary>‚öôÔ∏è Settings</summary>
    <div style="padding:14px" class="grid">
      <div class="field">
        <label>API Proxy URL (Cloudflare Worker)</label>
        <input id="apiUrl" placeholder="https://dnd-openai-proxy.&lt;subdomain&gt;.workers.dev"/>
        <div class="note">Your Worker‚Äôs <code>/chat</code> endpoint.</div>
      </div>
      <div class="field">
        <label>Generate images</label>
        <select id="imagesMode">
          <option value="auto">Auto (scene ‚â† none)</option>
          <option value="manual">Manual (only when pressed)</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div class="field">
        <label>Image size (cost control)</label>
        <select id="imgSize">
          <option value="1024">1024√ó1024</option>
          <option value="512">512√ó512</option>
          <option value="256">256√ó256</option>
        </select>
      </div>
      <div class="field">
        <label>Narrator voice</label>
        <select id="voiceSelect"></select>
        <div class="note">Uses your browser‚Äôs voices.</div>
      </div>
    </div>
    <div style="padding:0 14px 14px 14px;display:flex;gap:10px">
      <button id="saveSettings" class="btn">Save</button>
      <button id="clearSettings" class="btn-ghost">Clear</button>
      <button id="exportBtn" class="btn-ghost">Export Session</button>
    </div>
  </details>

  <!-- Art panel (sticky) -->
  <div class="art-panel">
    <img id="artThumb" class="art-thumb" alt="No art"/>
    <div>
      <div style="font-weight:700">Scene Art</div>
      <div id="artNote" class="note">No image yet.</div>
    </div>
    <div class="art-actions">
      <button id="viewFull" class="btn-ghost hidden">View</button>
      <button id="genArt" class="btn-ghost">Generate Art</button>
    </div>
  </div>
</div>

<!-- Fullscreen viewer -->
<div id="fs" class="fs-backdrop"><img id="fsImg" class="fs-img" alt="Art"/></div>

<!-- Revision tag -->
<div id="revisionTag">Revision 1</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // ---------- CONFIG ----------
  const API_BASE_DEFAULT = "https://dnd-openai-proxy.christestdnd.workers.dev"; // your Worker

  // ---------- STATE ----------
  const state = {
    apiBase: localStorage.getItem("apiBase") || API_BASE_DEFAULT,
    imagesMode: localStorage.getItem("imagesMode") || "auto",
    imgSize: localStorage.getItem("imgSize") || "1024",
    tts: JSON.parse(localStorage.getItem("tts") || "false"),
    voiceName: localStorage.getItem("voiceName") || "",
    history: [],
    lastSceneIndex: null,
    latestImageUrl: null
  };

  // ---------- ELEMENTS ----------
  const $ = id => document.getElementById(id);
  const logEl = $("log"), errBox = $("errbox");
  const apiBadge = $("apiBadge"), secureBadge = $("secureBadge");
  const speakBtn = $("holdToTalk");

  // Seed settings UI
  $("apiUrl").value = state.apiBase;
  $("imagesMode").value = state.imagesMode;
  $("imgSize").value = state.imgSize;
  $("ttsToggle").checked = state.tts;

  // ---------- STATUS ----------
  function setBadge(el, text, cls){
    el.textContent = text;
    el.className = "badge " + cls;
  }
  setBadge(secureBadge, location.protocol === 'https:' ? 'Secure: HTTPS' : 'Secure: Not HTTPS', location.protocol === 'https:' ? 'ok':'warn');

  async function pingAPI(){
    try {
      const res = await fetch(state.apiBase.replace(/\/$/,"") + "/health", { method:"GET" });
      if (res.ok) setBadge(apiBadge, "API: online", "ok");
      else setBadge(apiBadge, "API: error " + res.status, "err");
    } catch {
      setBadge(apiBadge, "API: unreachable", "err");
    }
  }
  pingAPI();

  function showError(msg){
    errBox.textContent = msg;
    errBox.classList.remove("hidden");
  }
  function clearError(){
    errBox.classList.add("hidden");
    errBox.textContent = "";
  }

  // ---------- RENDER ----------
  function render(){
    logEl.innerHTML = "";
    state.history.forEach((m,i)=>{
      const row = document.createElement("div");
      row.className = "msg " + (m.role==="user"?"user":"assistant");
      const b = document.createElement("div");
      b.className = "bubble";
      const r = document.createElement("div"); r.className="role"; r.textContent = m.role.toUpperCase();
      const t = document.createElement("div"); t.textContent = m.text;
      b.appendChild(r); b.appendChild(t); row.appendChild(b);

      if (m.imageUrl){
        const img = document.createElement("img");
        img.src = m.imageUrl; img.className="img"; img.alt = m.scene||"scene";
        row.appendChild(img);
      }
      if (m.role==="assistant" && m.scene && m.scene!=="none" && !m.imageUrl && state.imagesMode==="manual"){
        const btn = document.createElement("button");
        btn.textContent = "Generate Art for this scene";
        btn.className = "btn-ghost";
        btn.onclick = ()=> generateArt(i);
        row.appendChild(btn);
      }
      logEl.appendChild(row);
    });
    logEl.scrollTop = logEl.scrollHeight;

    const artThumb = $("artThumb"), artNote = $("artNote"), viewBtn = $("viewFull");
    if (state.latestImageUrl){
      artThumb.src = state.latestImageUrl;
      artNote.textContent = "Latest generated scene";
      viewBtn.classList.remove("hidden");
    } else {
      artThumb.src = ""; artThumb.alt = "No art";
      artNote.textContent = "No image yet.";
      viewBtn.classList.add("hidden");
    }
  }

  // ---------- TTS ----------
  const synth = window.speechSynthesis;
  let voices = [];
  function loadVoices(){
    try {
      voices = synth.getVoices();
      const sel = $("voiceSelect"); sel.innerHTML = "";
      const o0 = document.createElement("option"); o0.value=""; o0.textContent="System Default"; sel.appendChild(o0);
      voices.forEach(v=>{ const o=document.createElement("option"); o.value=v.name; o.textContent=\`\${v.name}\${v.lang? \` (\${v.lang})\` : ""}\`; sel.appendChild(o); });
      sel.value = state.voiceName;
    } catch {}
  }
  if (synth){ loadVoices(); synth.onvoiceschanged = loadVoices; }

  function speak(text){
    if (!state.tts || !text || !synth) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      if (state.voiceName){
        const v = voices.find(v=>v.name===state.voiceName);
        if (v) u.voice = v;
      }
      u.rate=1.02; u.pitch=1.0;
      synth.cancel(); synth.speak(u);
    }catch{}
  }

  // ---------- STT ----------
  const hasSTT = ('webkitSpeechRecognition' in window) && (window.isSecureContext || location.hostname==='localhost');
  const rec = hasSTT ? new webkitSpeechRecognition() : null;
  if (rec){
    rec.lang='en-US'; rec.continuous=false; rec.interimResults=false;
    let holding=false;
    const startRec = ()=>{ holding=true; clearError(); try{ rec.start(); $("holdToTalk").textContent="üéôÔ∏è Listening‚Ä¶ release to send"; }catch(e){ showError("Mic start error: "+e.message); } };
    const stopRec  = ()=>{ if(!holding) return; holding=false; try{ rec.stop(); $("holdToTalk").textContent="üéôÔ∏è Hold to talk"; }catch{} };

    $("holdToTalk").addEventListener("mousedown", startRec);
    $("holdToTalk").addEventListener("mouseup",   stopRec);
    $("holdToTalk").addEventListener("touchstart", (e)=>{ e.preventDefault(); startRec(); }, {passive:false});
    $("holdToTalk").addEventListener("touchend",   (e)=>{ e.preventDefault(); stopRec(); },   {passive:false});

    rec.onresult = (e)=>{
      const t = Array.from(e.results).map(r=>r[0].transcript).join(' ');
      $("input").value = t; send();
    };
    rec.onerror = (e)=> showError("Mic error: " + (e.error||"unknown"));
  } else {
    $("holdToTalk").textContent = "üéôÔ∏è Mic requires HTTPS";
    $("holdToTalk").disabled = true;
  }

  // ---------- CHAT ----------
  async function send(){
    clearError();
    const text = $("input").value.trim();
    if (!text) return;
    $("input").value = "";
    state.history.push({ role:"user", text });
    render();

    let data;
    try {
      const res = await fetch(state.apiBase.replace(/\/$/,"") + "/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ messages: state.history.map(m=>({ role:m.role, content:m.text })) })
      });
      if (!res.ok){
        const txt = await res.text();
        showError("HTTP " + res.status + " from API\n" + txt);
        data = { reply:"(API error.)", scene:"none" };
      } else {
        data = await res.json();
      }
    } catch (e) {
      showError("Network error: " + e.message);
      data = { reply:"(Network error.)", scene:"none" };
    }

    let sceneIndex = null;
    if (data.scene && data.scene !== "none") sceneIndex = state.history.length;

    let imageUrl = null;
    if (state.imagesMode==="auto" && data.scene && data.scene!=="none") {
      imageUrl = data.imageUrl || null;
      if (imageUrl) state.latestImageUrl = imageUrl;
    }

    state.history.push({ role:"assistant", text:data.reply || "(No reply)", scene:data.scene||"none", imageUrl });
    if (sceneIndex !== null) state.lastSceneIndex = sceneIndex;

    render();
    speak(data.reply);
  }

  // Manual art
  async function generateArt(indexOverride){
    clearError();
    const idx = (typeof indexOverride==="number") ? indexOverride : state.lastSceneIndex;
    if (idx==null){ showError("No recent scene to illustrate."); return; }
    const m = state.history[idx];
    if (!m || m.role!=="assistant" || !m.scene || m.scene==="none"){ showError("That turn doesn‚Äôt need art."); return; }

    try{
      const res = await fetch(state.apiBase.replace(/\/$/,"") + "/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          messages: [
            ...state.history.map(x=>({ role:x.role, content:x.text })),
            { role:"user", content:"Generate an illustration for the last scene only." }
          ]
        })
      });
      if (!res.ok){
        const txt = await res.text();
        showError("HTTP " + res.status + " from API\n" + txt);
        return;
      }
      const data = await res.json();
      if (data.imageUrl){
        m.imageUrl = data.imageUrl;
        state.latestImageUrl = data.imageUrl;
        render();
      } else {
        showError("No image returned. If you just verified your org for images, give it a few minutes and try again.");
      }
    } catch (e) {
      showError("Network error generating art: " + e.message);
    }
  }

  // ---------- UI WIRING ----------
  $("send").onclick = send;
  $("input").addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });
  $("settingsBtn").onclick = ()=> $("settingsPanel").open = !$("settingsPanel").open;
  $("saveSettings").onclick = ()=>{
    state.apiBase    = $("apiUrl").value.trim() || state.apiBase;
    state.imagesMode = $("imagesMode").value;
    state.imgSize    = $("imgSize").value;
    state.tts        = $("ttsToggle").checked;
    state.voiceName  = $("voiceSelect").value;
    localStorage.setItem("apiBase", state.apiBase);
    localStorage.setItem("imagesMode", state.imagesMode);
    localStorage.setItem("imgSize", state.imgSize);
    localStorage.setItem("tts", JSON.stringify(state.tts));
    localStorage.setItem("voiceName", state.voiceName);
    pingAPI();
    alert("Saved.");
  };
  $("clearSettings").onclick = ()=>{
    localStorage.removeItem("apiBase");
    localStorage.removeItem("imagesMode");
    localStorage.removeItem("imgSize");
    localStorage.removeItem("tts");
    localStorage.removeItem("voiceName");
    $("apiUrl").value = API_BASE_DEFAULT;
    $("imagesMode").value = "auto";
    $("imgSize").value = "1024";
    $("ttsToggle").checked = false;
    alert("Settings cleared.");
  };
  $("resetBtn").onclick = ()=>{ state.history=[]; state.latestImageUrl=null; state.lastSceneIndex=null; render(); };
  $("exportBtn").onclick = ()=>{
    const blob = new Blob([JSON.stringify(state.history,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="session.json"; a.click();
    URL.revokeObjectURL(url);
  };
  $("genArt").onclick = ()=> generateArt();
  $("viewFull").onclick = ()=>{
    if(!state.latestImageUrl) return;
    $("fsImg").src = state.latestImageUrl;
    $("fs").style.display = "flex";
  };
  $("fs").onclick = ()=>{ $("fs").style.display = "none"; };

  // Initial render
  render();
});
</script>
</body>
</html>
